---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Release.Name }}-manager
spec:
  replicas: {{ .Values.manager.replicas }}
  selector:
    matchLabels:
      app: {{ .Release.Name }}-manager
  template:
    metadata:
      labels:
        app: {{ .Release.Name }}-manager
    spec:
      containers:
        - name: manager
          image: {{ .Values.manager.image.repository }}{{ if .Values.manager.image.digest }}@{{ .Values.manager.image.digest }}{{ else }}:{{ coalesce .Values.manager.image.tag .Chart.AppVersion }}{{ end }}
          args: ["serve"]
          env:
            - name: REDIS_URL
              value: redis://{{ .Release.Name }}-redis-ha-haproxy:6379
            - name: HOOK_TOKEN
              value: {{ .Values.registry.hookToken | default "change-me" }}
            - name: PORT
              value: "8000"
            - name: INTERNAL_PORT
              value: "9090"
            - name: REGISTRY_URL
              value: http://{{ .Release.Name }}-registry:5000
            - name: HOSTNAME_OVERRIDE
              value: {{ .Values.ingress.host }}
            - name: DEFAULT_TTL
              value: {{ .Values.manager.env.defaultTTL | default "1h" | quote }}
            - name: MAX_TTL
              value: {{ .Values.manager.env.maxTTL | default "24h" | quote }}
            - name: REAP_INTERVAL
              value: {{ .Values.manager.env.reapInterval | default "1m" | quote }}
            - name: LOG_FORMAT
              value: {{ .Values.manager.env.logFormat | default "json" | quote }}
          ports:
            - containerPort: 8000
              name: http
            - containerPort: 9090
              name: internal
          livenessProbe:
            httpGet:
              path: /healthz
              port: internal
            initialDelaySeconds: 5
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /readyz
              port: internal
            initialDelaySeconds: 3
            periodSeconds: 5
